"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),!function(e,t){for(var i in t)Object.defineProperty(e,i,{enumerable:!0,get:t[i]})}(exports,{PlaywrightChromeProfile:function(){return h},getPlaywrightChromeProfileByEmail:function(){return c}});const e=require("playwright"),t=require("jnu-abc"),i=/*#__PURE__*/r(require("fs")),a=/*#__PURE__*/r(require("path"));function n(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function o(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,i=new WeakMap;return(o=function(e){return e?i:t})(e)}function r(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var i=o(t);if(i&&i.has(e))return i.get(e);var a={__proto__:null},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var r in e)if("default"!==r&&Object.prototype.hasOwnProperty.call(e,r)){var s=n?Object.getOwnPropertyDescriptor(e,r):null;s&&(s.get||s.set)?Object.defineProperty(a,r,s):a[r]=e[r]}return a.default=e,i&&i.set(e,a),a}process.env.CHROMIUM_EXECUTABLE_PATH;const s=process.env.CHROMIUM_USERDATA_PATH,l=e=>{let t=[];try{for(let n of i.readdirSync(e))if(n.startsWith("Profile")){let o=a.join(e,n);try{i.statSync(o).isDirectory()&&t.push(o.replace(/\\/g,"/"))}catch(e){continue}}}catch(t){console.warn(`Error reading directory ${e}: ${t.message}`)}return t},c=(e="",i="")=>{if(i||(i=s||"/root/.config/google-chrome"),!e)return"Default";try{for(let a of l(i))try{let i=(0,t.loadJson)(`${a}/Preferences`);if(i.account_info&&i.account_info.length>0&&i.account_info[0].email===e)return a.replace(/\\/g,"/").split("/").pop()||null}catch(e){continue}}catch(e){console.warn(`Error finding Chrome profiles: ${e.message}`)}return null};class h{async ensureInitialized(){await this.initPromise}async initializeBrowser(t){let n=t.profileName??c(t.email,t.userDataDir)??null,o=process.env.DOCKER_CONTAINER||process.env.CI||i.existsSync("/.dockerenv")||process.getuid?.()===0,r="true"===process.env.FORCE_CHROME_PROFILE,s=["--disable-gpu","--no-sandbox","--disable-dev-shm-usage","--disable-blink-features=AutomationControlled","--disable-extensions","--start-maximized","--window-size=1920,1080","--disable-web-security","--allow-running-insecure-content","--disable-popup-blocking","--disable-notifications","--disable-infobars","--ignore-certificate-errors","--disable-setuid-sandbox","--disable-background-timer-throttling","--disable-backgrounding-occluded-windows","--disable-renderer-backgrounding","--disable-features=TranslateUI","--disable-ipc-flooding-protection","--disable-default-apps","--disable-sync","--single-process","--no-zygote","--remote-debugging-port=0","--font-render-hinting=none","--enable-font-antialiasing","--force-device-scale-factor=1","--lang=ko-KR","--accept-lang=ko-KR,ko,en-US,en",...t.arguments||[]];if(n&&(!o||r)){o&&r&&console.log("✅ Profile settings forced in container environment");let i=a.join(t.userDataDir||"",n);this.context=await e.chromium.launchPersistentContext(i,{headless:t.headless||!1,executablePath:process.env.CHROMIUM_EXECUTABLE_PATH,args:s,userAgent:"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36",viewport:{width:1920,height:1080},locale:"ko-KR",timezoneId:"Asia/Seoul",permissions:["notifications"],extraHTTPHeaders:{"Accept-Language":"ko-KR,ko,en-US,en"}}),this.browser=this.context.browser(),this.page=this.context.pages()[0]||await this.context.newPage()}else{n&&o&&!r&&console.warn("Profile settings skipped in container environment for stability (set FORCE_CHROME_PROFILE=true to override)");let i={headless:t.headless||!1,args:s};process.env.CHROMIUM_EXECUTABLE_PATH&&(i.executablePath=process.env.CHROMIUM_EXECUTABLE_PATH),this.browser=await e.chromium.launch(i),this.context=await this.browser.newContext({userAgent:"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36",viewport:{width:1920,height:1080},locale:"ko-KR",timezoneId:"Asia/Seoul",permissions:["notifications"],extraHTTPHeaders:{"Accept-Language":"ko-KR,ko,en-US,en"}}),this.page=await this.context.newPage()}await this.page.addInitScript(()=>{Object.defineProperty(globalThis.navigator,"webdriver",{get:()=>void 0}),delete globalThis.cdc_adoQpoasnfa76pfcZLmcfl_Array,delete globalThis.cdc_adoQpoasnfa76pfcZLmcfl_Promise,delete globalThis.cdc_adoQpoasnfa76pfcZLmcfl_Symbol})}async getFullSize(){await this.ensureInitialized();let e=0,t=0;for(;;){let{viewportHeight:i,documentHeight:a,scrollY:n}=await this.page.evaluate(()=>{let e=globalThis,t=e.document;return{viewportHeight:e.innerHeight,documentHeight:Math.max(t.documentElement.scrollHeight,t.body.scrollHeight,t.documentElement.offsetHeight,t.body.offsetHeight),scrollY:e.scrollY||e.pageYOffset}});if(a===e){if(++t>=3)break}else t=0,e=a;let o=Math.min(n+800,a-i);if(n>=a-i)break;await this.page.evaluate(e=>{globalThis.scrollTo(0,e)},o),await this.page.waitForTimeout(2e3);try{await this.page.waitForFunction(e=>{let t=globalThis.document;return Math.max(t.documentElement.scrollHeight,t.body.scrollHeight,t.documentElement.offsetHeight,t.body.offsetHeight)>=e},a,{timeout:3e3})}catch(e){}}return await this.page.evaluate(()=>{let e=globalThis.document;return{width:Math.max(e.documentElement.scrollWidth,e.body.scrollWidth,e.documentElement.offsetWidth,e.body.offsetWidth),height:Math.max(e.documentElement.scrollHeight,e.body.scrollHeight,e.documentElement.offsetHeight,e.body.offsetHeight)}})}async _getFullScreenshot(){try{let{width:e,height:t}=await this.getFullSize();return await this.page.setViewportSize({width:e,height:t}),await this.page.screenshot({fullPage:!0,type:"png"})}catch(e){throw console.error("스크린샷 촬영 중 오류 발생:",e),e}}async getFullScreenshot(){try{return(await this._getFullScreenshot()).toString("base64")}finally{await this.close()}}async saveScreenshot(e){try{let i=await this._getFullScreenshot();(0,t.saveFile)(e,i.toString("base64"),{encoding:"base64"})}finally{await this.close()}}async goto(e){await this.ensureInitialized(),await this.page.goto(e,{waitUntil:"domcontentloaded"})}async wait(e,t={}){await this.ensureInitialized();let{timeout:i=1e4,state:a="attached"}=t;return this.page.waitForSelector(e,{timeout:i,state:a})}async findElements(e){return await this.ensureInitialized(),this.page.locator(e)}async findElement(e){return await this.ensureInitialized(),this.page.locator(e).first()}async getPageSource(){return await this.ensureInitialized(),await this.page.content()}async getElementHtml(e){let t=await this.findElement(e);return await t.innerHTML()}async click(e){let i=await this.findElement(e);await i.scrollIntoViewIfNeeded(),await (0,t.sleepAsync)(1e3),await i.click()}async getText(e){let t=await this.findElement(e);return await t.textContent()}async getAttribute(e,t){let i=await this.findElement(e);return await i.getAttribute(t)}async sendKeys(e,t){let i=await this.findElement(e);await i.fill(t)}async saveElementScreenshot(e,i){let a=await this.findElement(e),n=await a.screenshot({type:"png"});(0,t.saveFile)(i,n.toString("base64"),{encoding:"base64"})}async executeScript(e,...t){return await this.ensureInitialized(),this.page.evaluate(e,...t)}async scrollIntoView(e){let t=await this.findElement(e);await t.scrollIntoViewIfNeeded()}async close(){await this.ensureInitialized(),this.page&&await this.page.close(),this.context&&await this.context.close(),this.browser&&await this.browser.close()}constructor(e={headless:!1,profileName:"",email:"",userDataDir:"",arguments:[]}){n(this,"browser",void 0),n(this,"context",void 0),n(this,"page",void 0),n(this,"initPromise",void 0),this.initPromise=this.initializeBrowser(e)}}
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),!function(e,t){for(var i in t)Object.defineProperty(e,i,{enumerable:!0,get:t[i]})}(exports,{PlaywrightChromeProfile:function(){return f},copyProfileData:function(){return g},findExistingTempProfile:function(){return u},getPlaywrightChromeProfileByEmail:function(){return h}});const e=require("playwright"),t=require("jnu-abc"),i=/*#__PURE__*/l(require("fs")),o=/*#__PURE__*/l(require("path")),r=require("child_process"),a=/*#__PURE__*/l(require("os"));function n(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function s(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,i=new WeakMap;return(s=function(e){return e?i:t})(e)}function l(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var i=s(t);if(i&&i.has(e))return i.get(e);var o={__proto__:null},r=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var a in e)if("default"!==a&&Object.prototype.hasOwnProperty.call(e,a)){var n=r?Object.getOwnPropertyDescriptor(e,a):null;n&&(n.get||n.set)?Object.defineProperty(o,a,n):o[a]=e[a]}return o.default=e,i&&i.set(e,o),o}const c=e=>{let t=[];try{for(let r of i.readdirSync(e))if(r.startsWith("Profile")){let a=o.join(e,r);try{i.statSync(a).isDirectory()&&t.push(a.replace(/\\/g,"/"))}catch(e){continue}}}catch(t){console.warn(`Error reading directory ${e}: ${t.message}`)}return t},h=(e="",i="")=>{if(i||(i=process.env.CHROMIUM_USERDATA_PATH||"/root/.config/google-chrome"),!e)return"Default";try{let o=c(i),r=[];for(let i of o)try{let o=(0,t.loadJson)(`${i}/Preferences`);if(o.account_info&&o.account_info.length>0){for(let t=0;t<o.account_info.length;t++)if(o.account_info[t].email===e){r.push({folder:i.replace(/\\/g,"/").split("/").pop()||"",isPrimary:0===t});break}}}catch(e){continue}let a=r.find(e=>e.isPrimary);if(a)return console.log(`âœ… ì£¼ê³„ì •ìœ¼ë¡œ ë“±ë¡ëœ í”„ë¡œí•„ ë°œê²¬: ${a.folder}`),a.folder;if(r.length>0)return console.log(`âš ï¸ ë³´ì¡°ê³„ì •ìœ¼ë¡œë§Œ ë“±ë¡ë¨. ì²« ë²ˆì§¸ í”„ë¡œí•„ ì‚¬ìš©: ${r[0].folder}`),r[0].folder}catch(e){console.warn(`Error finding Chrome profiles: ${e.message}`)}return null},u=e=>{try{let t=a.tmpdir(),r=o.join(t,e);if(i.existsSync(r)){let e=o.join(r,"Default");if(i.existsSync(e))return console.log(`ğŸ” ê¸°ì¡´ ì„ì‹œ í”„ë¡œí•„ ë°œê²¬: ${r}`),r}return null}catch(e){return console.log(`âš ï¸  ê¸°ì¡´ ì„ì‹œ í”„ë¡œí•„ ê²€ìƒ‰ ì‹¤íŒ¨: ${e.message}`),null}},g=(e,t,r)=>{console.log("ğŸ“‹ í”„ë¡œí•„ ë°ì´í„°ë¥¼ ë³µì‚¬í•©ë‹ˆë‹¤...");let a=o.join(r,e);i.existsSync(t)||i.mkdirSync(t,{recursive:!0});let n=0;for(let e of["Cookies","Login Data","Preferences","Secure Preferences","Web Data","History","Bookmarks","Google Profile.ico","First Run","Local State","Network Action Predictor","Network Persistent State","Sync Data","TransportSecurity","Visited Links","Token Service","Account Manager","Login Data For Account","Network","Profile Avatar","Client Side Phishing Model","Safe Browsing","Session","Shortcuts","Top Sites","Trusted Vault","User Data"]){let r=o.join(a,e),s=o.join(t,e);if(i.existsSync(r))try{i.copyFileSync(r,s),n++,console.log(`   âœ… ${e} ë³µì‚¬ë¨`)}catch(t){console.log(`   âš ï¸  ${e} ë³µì‚¬ ì‹¤íŒ¨: ${t.message}`)}}for(let e of["Local Storage","Session Storage","IndexedDB","databases","Sync Data","blob_storage","File System","Platform Notifications"]){let r=o.join(a,e),s=o.join(t,e);if(i.existsSync(r))try{i.cpSync(r,s,{recursive:!0,force:!0}),n++,console.log(`   âœ… ${e}/ ë³µì‚¬ë¨`)}catch(t){console.log(`   âš ï¸  ${e}/ ë³µì‚¬ ì‹¤íŒ¨: ${t.message}`)}}return console.log(`   ğŸ“Š ì´ ${n}ê°œ í•­ëª©ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.`),n>0};class f{async ensureInitialized(){await this.initPromise}async initializeBrowser(t){console.log("ğŸ­ Playwright persistent context ë°©ì‹ìœ¼ë¡œ Chrome ì‹¤í–‰ (CDP ì—†ìŒ)");let n=t.profileName??h(t.email,t.userDataDir)??null;if(!n)throw Error(`Profile not found for email: ${t.email}`);try{(0,r.execSync)('pkill -TERM -f "Google Chrome"',{stdio:"ignore"}),console.log("ğŸ”„ ê¸°ì¡´ Chrome í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ"),await new Promise(e=>setTimeout(e,2e3))}catch(e){}let s=t.userDataDir||process.env.CHROMIUM_USERDATA_PATH||"/Users/youchan/Library/Application Support/Google/Chrome",l=o.join(s,n);if(!i.existsSync(l))throw Error(`Chrome í”„ë¡œí•„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${l}`);console.log(`ğŸ“ ì›ë³¸ Chrome í”„ë¡œí•„: ${l}`);let c=process.env.CHROMIUM_EXECUTABLE_PATH||("win32"===process.platform?"C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe":"darwin"===process.platform?"/Applications/Google Chrome.app/Contents/MacOS/Google Chrome":"/usr/bin/google-chrome");if(!i.existsSync(c))throw Error(`Chrome ì‹¤í–‰ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${c}`);console.log(`ğŸ”§ Chrome ì‹¤í–‰ íŒŒì¼: ${c}`);let f=s,d=n;if(t.useTempProfile){let e=n.replace(/\s/g,"_").replace(/[/\\]/g,"_"),t=`chrome-profile-${e}`,i=u(t);if(i)console.log(`â™»ï¸  ê¸°ì¡´ ì„ì‹œ í”„ë¡œí•„ì„ ì¬ì‚¬ìš©í•©ë‹ˆë‹¤: ${i}`),this.tempUserDataDir=i,f=this.tempUserDataDir,d="Default";else{this.tempUserDataDir=o.join(a.tmpdir(),t);let e=o.join(this.tempUserDataDir,"Default");console.log(`ğŸ†• ìƒˆ ì„ì‹œ í”„ë¡œí•„ì„ ìƒì„±í•©ë‹ˆë‹¤: ${this.tempUserDataDir}`),g(n,e,s)||console.log("âš ï¸  í”„ë¡œí•„ ë°ì´í„° ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¹ˆ í”„ë¡œí•„ë¡œ ì§„í–‰í•©ë‹ˆë‹¤."),f=this.tempUserDataDir,d="Default"}}console.log(`ğŸ”§ ì‚¬ìš©í•  í”„ë¡œí•„ ê²½ë¡œ: ${o.join(f,d)}`),this.context=await e.chromium.launchPersistentContext(f,{headless:t.headless??!1,executablePath:c,args:[`--profile-directory=${d}`,"--no-first-run","--disable-default-apps","--disable-sync","--disable-extensions","--disable-background-networking","--disable-background-timer-throttling","--disable-renderer-backgrounding","--disable-backgrounding-occluded-windows","--disable-features=TranslateUI,VizDisplayCompositor","--no-sandbox","--disable-dev-shm-usage","--start-maximized",...t.arguments||[]]}),this.browser=this.context.browser();let m=this.context.pages();m.length>0?this.page=m[0]:this.page=await this.context.newPage(),console.log("âœ… Playwright persistent context ì—°ê²° ì™„ë£Œ (CDP ì—†ìŒ)")}async getFullSize(){await this.ensureInitialized();let e=0,t=0;for(;;){let{viewportHeight:i,documentHeight:o,scrollY:r}=await this.page.evaluate(()=>{let e=globalThis,t=e.document;return{viewportHeight:e.innerHeight,documentHeight:Math.max(t.documentElement.scrollHeight,t.body.scrollHeight,t.documentElement.offsetHeight,t.body.offsetHeight),scrollY:e.scrollY||e.pageYOffset}});if(o===e){if(++t>=3)break}else t=0,e=o;let a=Math.min(r+800,o-i);if(r>=o-i)break;await this.page.evaluate(e=>{globalThis.scrollTo(0,e)},a),await this.page.waitForTimeout(2e3);try{await this.page.waitForFunction(e=>{let t=globalThis.document;return Math.max(t.documentElement.scrollHeight,t.body.scrollHeight,t.documentElement.offsetHeight,t.body.offsetHeight)>=e},o,{timeout:3e3})}catch(e){}}return await this.page.evaluate(()=>{let e=globalThis.document;return{width:Math.max(e.documentElement.scrollWidth,e.body.scrollWidth,e.documentElement.offsetWidth,e.body.offsetWidth),height:Math.max(e.documentElement.scrollHeight,e.body.scrollHeight,e.documentElement.offsetHeight,e.body.offsetHeight)}})}async _getFullScreenshot(){try{let{width:e,height:t}=await this.getFullSize();return await this.page.setViewportSize({width:e,height:t}),await this.page.screenshot({fullPage:!0,type:"png"})}catch(e){throw console.error("ìŠ¤í¬ë¦°ìƒ· ì´¬ì˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:",e),e}}async getFullScreenshot(){try{return(await this._getFullScreenshot()).toString("base64")}finally{await this.close()}}async saveScreenshot(e){try{let i=await this._getFullScreenshot();(0,t.saveFile)(e,i.toString("base64"),{encoding:"base64"})}finally{await this.close()}}async goto(e){await this.ensureInitialized(),await this.page.goto(e,{waitUntil:"domcontentloaded"})}async wait(e,t={}){await this.ensureInitialized();let{timeout:i=1e4,state:o="attached"}=t;return this.page.waitForSelector(e,{timeout:i,state:o})}async findElements(e){return await this.ensureInitialized(),this.page.locator(e)}async findElement(e){return await this.ensureInitialized(),this.page.locator(e).first()}async getPageSource(){return await this.ensureInitialized(),await this.page.content()}async getElementHtml(e){let t=await this.findElement(e);return await t.innerHTML()}async click(e){let i=await this.findElement(e);await i.scrollIntoViewIfNeeded(),await (0,t.sleepAsync)(1e3),await i.click()}async getText(e){let t=await this.findElement(e);return await t.textContent()}async getAttribute(e,t){let i=await this.findElement(e);return await i.getAttribute(t)}async sendKeys(e,t){let i=await this.findElement(e);await i.fill(t)}async saveElementScreenshot(e,i){let o=await this.findElement(e),r=await o.screenshot({type:"png"});(0,t.saveFile)(i,r.toString("base64"),{encoding:"base64"})}async executeScript(e,...t){return await this.ensureInitialized(),this.page.evaluate(e,...t)}async scrollIntoView(e){let t=await this.findElement(e);await t.scrollIntoViewIfNeeded()}async close(){await this.ensureInitialized(),this.context&&(await this.context.close(),console.log("âœ… Playwright persistent context ì¢…ë£Œ")),this.tempUserDataDir&&i.existsSync(this.tempUserDataDir)&&(console.log(`ğŸ’¾ ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€ë¥¼ ìœ„í•´ ì„ì‹œ í”„ë¡œí•„ì„ ë³´ì¡´í•©ë‹ˆë‹¤: ${this.tempUserDataDir}`),console.log("   ë‹¤ìŒ ì‹¤í–‰ ì‹œ ì´ í”„ë¡œí•„ì´ ì¬ì‚¬ìš©ë©ë‹ˆë‹¤."))}constructor(e={headless:!1,profileName:"",email:"",userDataDir:"",arguments:[],useTempProfile:!1}){n(this,"browser",void 0),n(this,"context",void 0),n(this,"page",void 0),n(this,"initPromise",void 0),n(this,"tempUserDataDir",void 0),this.initPromise=this.initializeBrowser(e)}}
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),!function(e,t){for(var i in t)Object.defineProperty(e,i,{enumerable:!0,get:t[i]})}(exports,{PlaywrightChromeProfile:function(){return h},getPlaywrightChromeProfileByEmail:function(){return c}});const e=require("playwright"),t=require("jnu-abc"),i=/*#__PURE__*/s(require("fs")),r=/*#__PURE__*/s(require("path")),o=require("child_process");function a(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function n(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,i=new WeakMap;return(n=function(e){return e?i:t})(e)}function s(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var i=n(t);if(i&&i.has(e))return i.get(e);var r={__proto__:null},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var a in e)if("default"!==a&&Object.prototype.hasOwnProperty.call(e,a)){var s=o?Object.getOwnPropertyDescriptor(e,a):null;s&&(s.get||s.set)?Object.defineProperty(r,a,s):r[a]=e[a]}return r.default=e,i&&i.set(e,r),r}process.env.CHROMIUM_EXECUTABLE_PATH;const l=e=>{let t=[];try{for(let o of i.readdirSync(e))if(o.startsWith("Profile")){let a=r.join(e,o);try{i.statSync(a).isDirectory()&&t.push(a.replace(/\\/g,"/"))}catch(e){continue}}}catch(t){console.warn(`Error reading directory ${e}: ${t.message}`)}return t},c=(e="",i="")=>{if(i||(i=process.env.CHROMIUM_USERDATA_PATH||"/root/.config/google-chrome"),!e)return"Default";try{let r=l(i),o=[];for(let i of r)try{let r=(0,t.loadJson)(`${i}/Preferences`);if(r.account_info&&r.account_info.length>0){for(let t=0;t<r.account_info.length;t++)if(r.account_info[t].email===e){o.push({folder:i.replace(/\\/g,"/").split("/").pop()||"",isPrimary:0===t});break}}}catch(e){continue}let a=o.find(e=>e.isPrimary);if(a)return console.log(`✅ 주계정으로 등록된 프로필 발견: ${a.folder}`),a.folder;if(o.length>0)return console.log(`⚠️ 보조계정으로만 등록됨. 첫 번째 프로필 사용: ${o[0].folder}`),o[0].folder}catch(e){console.warn(`Error finding Chrome profiles: ${e.message}`)}return null};class h{async ensureInitialized(){await this.initPromise}async initializeBrowser(t){let a=t.profileName??c(t.email,t.userDataDir)??null;if(!a)throw Error(`Profile not found for email: ${t.email}`);try{(0,o.execSync)('pkill -f "Google Chrome"',{stdio:"ignore"}),console.log("🔄 기존 Chrome 프로세스 종료"),await new Promise(e=>setTimeout(e,2e3))}catch(e){}let n=t.userDataDir||process.env.CHROMIUM_USERDATA_PATH||"/Users/youchan/Library/Application Support/Google/Chrome",s=r.join(n,a);if(!i.existsSync(s))throw Error(`Chrome 프로필을 찾을 수 없습니다: ${s}`);console.log(`📁 Chrome 프로필: ${s}`);let l=["--remote-debugging-port=9222",`--user-data-dir=${n}`,`--profile-directory=${a}`,"--no-first-run","--disable-default-apps","--start-maximized","--disable-web-security","--allow-running-insecure-content","--disable-features=VizDisplayCompositor",...t.arguments||[]];console.log("🌐 Chrome 실행 중..."),this.chromeProcess=(0,o.spawn)("/Applications/Google Chrome.app/Contents/MacOS/Google Chrome",l,{detached:!0,stdio:"ignore"}),console.log("⏳ Chrome 시작 대기 중... (5초)"),await new Promise(e=>setTimeout(e,5e3)),console.log("🔗 Playwright로 Chrome에 연결 중..."),this.browser=await e.chromium.connectOverCDP("http://localhost:9222");let h=this.browser.contexts();this.context=h.length>0?h[0]:await this.browser.newContext();let u=await this.context.pages();u.length>0?this.page=u[0]:this.page=await this.context.newPage(),console.log("✅ Chrome 연결 완료")}async getFullSize(){await this.ensureInitialized();let e=0,t=0;for(;;){let{viewportHeight:i,documentHeight:r,scrollY:o}=await this.page.evaluate(()=>{let e=globalThis,t=e.document;return{viewportHeight:e.innerHeight,documentHeight:Math.max(t.documentElement.scrollHeight,t.body.scrollHeight,t.documentElement.offsetHeight,t.body.offsetHeight),scrollY:e.scrollY||e.pageYOffset}});if(r===e){if(++t>=3)break}else t=0,e=r;let a=Math.min(o+800,r-i);if(o>=r-i)break;await this.page.evaluate(e=>{globalThis.scrollTo(0,e)},a),await this.page.waitForTimeout(2e3);try{await this.page.waitForFunction(e=>{let t=globalThis.document;return Math.max(t.documentElement.scrollHeight,t.body.scrollHeight,t.documentElement.offsetHeight,t.body.offsetHeight)>=e},r,{timeout:3e3})}catch(e){}}return await this.page.evaluate(()=>{let e=globalThis.document;return{width:Math.max(e.documentElement.scrollWidth,e.body.scrollWidth,e.documentElement.offsetWidth,e.body.offsetWidth),height:Math.max(e.documentElement.scrollHeight,e.body.scrollHeight,e.documentElement.offsetHeight,e.body.offsetHeight)}})}async _getFullScreenshot(){try{let{width:e,height:t}=await this.getFullSize();return await this.page.setViewportSize({width:e,height:t}),await this.page.screenshot({fullPage:!0,type:"png"})}catch(e){throw console.error("스크린샷 촬영 중 오류 발생:",e),e}}async getFullScreenshot(){try{return(await this._getFullScreenshot()).toString("base64")}finally{await this.close()}}async saveScreenshot(e){try{let i=await this._getFullScreenshot();(0,t.saveFile)(e,i.toString("base64"),{encoding:"base64"})}finally{await this.close()}}async goto(e){await this.ensureInitialized(),await this.page.goto(e,{waitUntil:"domcontentloaded"})}async wait(e,t={}){await this.ensureInitialized();let{timeout:i=1e4,state:r="attached"}=t;return this.page.waitForSelector(e,{timeout:i,state:r})}async findElements(e){return await this.ensureInitialized(),this.page.locator(e)}async findElement(e){return await this.ensureInitialized(),this.page.locator(e).first()}async getPageSource(){return await this.ensureInitialized(),await this.page.content()}async getElementHtml(e){let t=await this.findElement(e);return await t.innerHTML()}async click(e){let i=await this.findElement(e);await i.scrollIntoViewIfNeeded(),await (0,t.sleepAsync)(1e3),await i.click()}async getText(e){let t=await this.findElement(e);return await t.textContent()}async getAttribute(e,t){let i=await this.findElement(e);return await i.getAttribute(t)}async sendKeys(e,t){let i=await this.findElement(e);await i.fill(t)}async saveElementScreenshot(e,i){let r=await this.findElement(e),o=await r.screenshot({type:"png"});(0,t.saveFile)(i,o.toString("base64"),{encoding:"base64"})}async executeScript(e,...t){return await this.ensureInitialized(),this.page.evaluate(e,...t)}async scrollIntoView(e){let t=await this.findElement(e);await t.scrollIntoViewIfNeeded()}async close(){if(await this.ensureInitialized(),this.browser&&(await this.browser.close(),console.log("✅ Playwright 연결 종료")),this.chromeProcess)try{process.kill(-this.chromeProcess.pid),console.log("✅ Chrome 프로세스 종료")}catch(e){console.log("ℹ️ Chrome 프로세스 종료 실패 (이미 종료되었을 수 있음)")}}constructor(e={headless:!1,profileName:"",email:"",userDataDir:"",arguments:[]}){a(this,"browser",void 0),a(this,"context",void 0),a(this,"page",void 0),a(this,"initPromise",void 0),a(this,"chromeProcess",void 0),this.initPromise=this.initializeBrowser(e)}}
"use strict";var e;Object.defineProperty(exports,"__esModule",{value:!0}),!function(e,t){for(var i in t)Object.defineProperty(e,i,{enumerable:!0,get:t[i]})}(exports,{SeleniumChromeProfile:function(){return h},copyProfileData:function(){return m},findExistingTempProfile:function(){return f},getSeleniumChromeProfileByEmail:function(){return u}});const t=require("selenium-webdriver"),i=(e=require("selenium-webdriver/chrome.js"))&&e.__esModule?e:{default:e},n=require("jnu-abc"),r=/*#__PURE__*/c(require("fs")),a=/*#__PURE__*/c(require("path")),s=/*#__PURE__*/c(require("os"));function o(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function l(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,i=new WeakMap;return(l=function(e){return e?i:t})(e)}function c(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var i=l(t);if(i&&i.has(e))return i.get(e);var n={__proto__:null},r=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var a in e)if("default"!==a&&Object.prototype.hasOwnProperty.call(e,a)){var s=r?Object.getOwnPropertyDescriptor(e,a):null;s&&(s.get||s.set)?Object.defineProperty(n,a,s):n[a]=e[a]}return n.default=e,i&&i.set(e,n),n}process.env.CHROMIUM_EXECUTABLE_PATH;const d=e=>{let t=[];try{for(let i of r.readdirSync(e))if(i.startsWith("Profile")){let n=a.join(e,i);try{r.statSync(n).isDirectory()&&t.push(n.replace(/\\/g,"/"))}catch(e){continue}}}catch(t){console.warn(`Error reading directory ${e}: ${t.message}`)}return t},u=(e="",t="")=>{if(t||(t=process.env.CHROMIUM_USERDATA_PATH||"/root/.config/google-chrome",console.log(`ğŸ”§ í”„ë¡œí•„ ì°¾ê¸° - ì‚¬ìš©í•  userDataDir: ${t}`),console.log(`ğŸ”§ í™˜ê²½ë³€ìˆ˜ CHROMIUM_USERDATA_PATH: ${process.env.CHROMIUM_USERDATA_PATH}`)),!e)return null;try{let i=d(t),r=[];for(let t of i)try{let i=(0,n.loadJson)(`${t}/Preferences`);if(i.account_info&&i.account_info.length>0){for(let n=0;n<i.account_info.length;n++)if(i.account_info[n].email===e){r.push({folder:t.replace(/\\/g,"/").split("/").pop()||"",isPrimary:0===n});break}}}catch(e){continue}let a=r.find(e=>e.isPrimary);if(a)return console.log(`âœ… ì£¼ê³„ì •ìœ¼ë¡œ ë“±ë¡ëœ í”„ë¡œí•„ ë°œê²¬: ${a.folder}`),a.folder;if(r.length>0)return console.log(`âš ï¸ ë³´ì¡°ê³„ì •ìœ¼ë¡œë§Œ ë“±ë¡ë¨. ì²« ë²ˆì§¸ í”„ë¡œí•„ ì‚¬ìš©: ${r[0].folder}`),r[0].folder}catch(e){console.warn(`Error finding Chrome profiles: ${e.message}`)}return null},f=e=>{try{let t=s.tmpdir(),i=a.join(t,e);if(r.existsSync(i)){let e=a.join(i,"Default");if(r.existsSync(e))return console.log(`ğŸ” ê¸°ì¡´ ì„ì‹œ í”„ë¡œí•„ ë°œê²¬: ${i}`),i}return null}catch(e){return console.log(`âš ï¸  ê¸°ì¡´ ì„ì‹œ í”„ë¡œí•„ ê²€ìƒ‰ ì‹¤íŒ¨: ${e.message}`),null}},m=(e,t,i)=>{console.log("ğŸ“‹ í”„ë¡œí•„ ë°ì´í„°ë¥¼ ë³µì‚¬í•©ë‹ˆë‹¤...");let n=a.join(i,e);r.existsSync(t)||r.mkdirSync(t,{recursive:!0});let s=0;for(let e of["Cookies","Login Data","Preferences","Secure Preferences","Web Data","History","Bookmarks","Google Profile.ico","First Run","Local State","Network Action Predictor","Network Persistent State","Sync Data","TransportSecurity","Visited Links","Token Service","Account Manager","Login Data For Account","Network","Profile Avatar","Client Side Phishing Model","Safe Browsing","Session","Shortcuts","Top Sites","Trusted Vault","User Data"]){let i=a.join(n,e),o=a.join(t,e);if(r.existsSync(i))try{r.copyFileSync(i,o),s++,console.log(`   âœ… ${e} ë³µì‚¬ë¨`)}catch(t){console.log(`   âš ï¸  ${e} ë³µì‚¬ ì‹¤íŒ¨: ${t.message}`)}}for(let e of["Local Storage","Session Storage","IndexedDB","databases","Sync Data","blob_storage","File System","Platform Notifications"]){let i=a.join(n,e),o=a.join(t,e);if(r.existsSync(i))try{r.cpSync(i,o,{recursive:!0,force:!0}),s++,console.log(`   âœ… ${e}/ ë³µì‚¬ë¨`)}catch(t){console.log(`   âš ï¸  ${e}/ ë³µì‚¬ ì‹¤íŒ¨: ${t.message}`)}}return console.log(`   ğŸ“Š ì´ ${s}ê°œ í•­ëª©ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.`),s>0};class h{async ensureInitialized(){await this.initPromise}async initializeDriver(e){console.log("ğŸ”§ Selenium Chrome Profile ì´ˆê¸°í™” ì¤‘...");let n=new i.default.Options,o=process.env.CHROMIUM_EXECUTABLE_PATH||("win32"===process.platform?"C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe":"darwin"===process.platform?"/Applications/Google Chrome.app/Contents/MacOS/Google Chrome":"/usr/bin/google-chrome");if(!r.existsSync(o))throw Error(`Chrome ì‹¤í–‰ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${o}`);n.setChromeBinaryPath(o),console.log(`ğŸ”§ Chrome ì‹¤í–‰ íŒŒì¼: ${o}`),e.headless&&n.addArguments("--headless=new");let l=e.profileName??u(e.email,e.userDataDir)??null,c=process.env.DOCKER_CONTAINER||process.env.CI||r.existsSync("/.dockerenv")||process.getuid?.()===0,d="true"===process.env.FORCE_CHROME_PROFILE;if(l&&"null"!==l&&"undefined"!==l){let t=e.userDataDir||process.env.CHROMIUM_USERDATA_PATH||("win32"===process.platform?"C:\\Users\\"+s.userInfo().username+"\\AppData\\Local\\Google\\Chrome\\User Data":"darwin"===process.platform?"/Users/"+s.userInfo().username+"/Library/Application Support/Google/Chrome":"/home/"+s.userInfo().username+"/.config/google-chrome"),i=t,r=l;if(e.useTempProfile){let e=l.replace(/\s/g,"_").replace(/[/\\]/g,"_"),n=`chrome-selenium-${e}`,o=f(n);if(o)console.log(`â™»ï¸  ê¸°ì¡´ ì„ì‹œ í”„ë¡œí•„ì„ ì¬ì‚¬ìš©í•©ë‹ˆë‹¤: ${o}`),this.tempUserDataDir=o,i=this.tempUserDataDir,r="Default";else{this.tempUserDataDir=a.join(s.tmpdir(),n);let e=a.join(this.tempUserDataDir,"Default");console.log(`ğŸ†• ìƒˆ ì„ì‹œ í”„ë¡œí•„ì„ ìƒì„±í•©ë‹ˆë‹¤: ${this.tempUserDataDir}`),m(l,e,t)||console.log("âš ï¸  í”„ë¡œí•„ ë°ì´í„° ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¹ˆ í”„ë¡œí•„ë¡œ ì§„í–‰í•©ë‹ˆë‹¤."),i=this.tempUserDataDir,r="Default"}}if(!c||d||e.useTempProfile)n.addArguments(`--user-data-dir=${i}`),n.addArguments(`--profile-directory=${r}`),console.log(`ğŸ“ Chrome í”„ë¡œí•„ ì„¤ì •: ${i}/${r}`),c&&d&&console.log("âœ… Profile settings forced in container environment");else{console.warn("Profile settings skipped in container environment for stability (set FORCE_CHROME_PROFILE=true to override)");let e=`/tmp/chrome-selenium-${Date.now()}`;n.addArguments(`--user-data-dir=${e}`),console.log(`ğŸ“ ì„ì‹œ Chrome í”„ë¡œí•„ ì‚¬ìš© (ì»¨í…Œì´ë„ˆ í™˜ê²½): ${e}`)}}else{let e=`/tmp/chrome-selenium-${Date.now()}`;n.addArguments(`--user-data-dir=${e}`),console.log(`ğŸ“ ì„ì‹œ Chrome í”„ë¡œí•„ ì‚¬ìš©: ${e}`),console.warn("âš ï¸ í”„ë¡œí•„ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ ì„ì‹œ í”„ë¡œí•„ì„ ìƒì„±í•©ë‹ˆë‹¤.")}let h=[];l&&"null"!==l&&"undefined"!==l?(h=["--no-first-run","--disable-default-apps","--start-maximized","--window-size=1920,1080","--disable-popup-blocking","--disable-notifications","--ignore-certificate-errors","--disable-background-timer-throttling","--disable-backgrounding-occluded-windows","--disable-renderer-backgrounding","--disable-features=TranslateUI","--disable-ipc-flooding-protection","--font-render-hinting=none","--enable-font-antialiasing","--force-device-scale-factor=1","--lang=ko-KR","--accept-lang=ko-KR,ko,en-US,en","--user-agent=Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36"],console.log("ğŸ”§ ì‹¤ì œ í”„ë¡œí•„ ì‚¬ìš© - ì•ˆì •ì„± ì¤‘ì‹¬ ì˜µì…˜ ì ìš©")):(h=["--disable-gpu","--no-sandbox","--disable-dev-shm-usage","--disable-blink-features=AutomationControlled","--disable-extensions","--start-maximized","--window-size=1920,1080","--disable-web-security","--allow-running-insecure-content","--disable-popup-blocking","--disable-notifications","--disable-infobars","--ignore-certificate-errors","--disable-setuid-sandbox","--disable-background-timer-throttling","--disable-backgrounding-occluded-windows","--disable-renderer-backgrounding","--disable-features=TranslateUI,VizDisplayCompositor","--disable-ipc-flooding-protection","--disable-default-apps","--remote-debugging-port=0","--font-render-hinting=none","--enable-font-antialiasing","--force-device-scale-factor=1","--lang=ko-KR","--accept-lang=ko-KR,ko,en-US,en","--user-agent=Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36","--enable-automation","--no-default-browser-check","--disable-background-networking","--disable-extensions-file-access-check","--disable-component-extensions-with-background-pages"],console.log("ğŸ”§ ì„ì‹œ í”„ë¡œí•„ ì‚¬ìš© - ìë™í™” ìš°íšŒ ì˜µì…˜ ì ìš©")),[...h,...e.arguments||[]].forEach(e=>n.addArguments(e)),n.excludeSwitches("enable-automation"),n.excludeSwitches("enable-logging"),n.setUserPreferences({credentials_enable_service:!1,"profile.password_manager_enabled":!1,useAutomationExtension:!1,excludeSwitches:["enable-automation"],"profile.default_content_setting_values.notifications":2,"profile.managed_default_content_settings.images":1,"profile.default_content_settings.popups":0,"webkit.webprefs.fonts.standard.Hang":"Noto Sans CJK KR","webkit.webprefs.fonts.serif.Hang":"Noto Serif CJK KR","webkit.webprefs.fonts.sansserif.Hang":"Noto Sans CJK KR","webkit.webprefs.fonts.fixed.Hang":"NanumGothicCoding","webkit.webprefs.fonts.cursive.Hang":"Noto Sans CJK KR","webkit.webprefs.fonts.fantasy.Hang":"Noto Sans CJK KR"}),this.driver=await new t.Builder().forBrowser("chrome").setChromeOptions(n).build(),this.driver.executeScript(`
      // navigator.webdriver ì†ì„± ì œê±°
      Object.defineProperty(navigator, 'webdriver', {
        get: () => undefined
      });

      // Chrome ìë™í™” ê´€ë ¨ ì†ì„± ì œê±°
      delete window.cdc_adoQpoasnfa76pfcZLmcfl_Array;
      delete window.cdc_adoQpoasnfa76pfcZLmcfl_Promise;
      delete window.cdc_adoQpoasnfa76pfcZLmcfl_Symbol;
    `)}async getFullSize(){await this.ensureInitialized();let e=0,t=0;for(;;){let{viewportHeight:i,documentHeight:n,scrollY:r}=await this.driver.executeScript(`
        return {
          viewportHeight: window.innerHeight,
          documentHeight: Math.max(
            document.documentElement.scrollHeight,
            document.body.scrollHeight,
            document.documentElement.offsetHeight,
            document.body.offsetHeight
          ),
          scrollY: window.scrollY || window.pageYOffset
        }
      `);if(n===e){if(++t>=3)break}else t=0,e=n;let a=Math.min(r+800,n-i);if(r>=n-i)break;await this.driver.executeScript(`window.scrollTo(0, ${a})`),await this.driver.sleep(2e3),await this.driver.wait(async()=>await this.driver.executeScript(`
          return Math.max(
            document.documentElement.scrollHeight,
            document.body.scrollHeight,
            document.documentElement.offsetHeight,
            document.body.offsetHeight
          )
        `)>=n,3e3).catch(()=>{})}return await this.driver.executeScript(`
      return {
        width: Math.max(
          document.documentElement.scrollWidth,
          document.body.scrollWidth,
          document.documentElement.offsetWidth,
          document.body.offsetWidth
        ),
        height: Math.max(
          document.documentElement.scrollHeight,
          document.body.scrollHeight,
          document.documentElement.offsetHeight,
          document.body.offsetHeight
        )
      }
    `)}async _getFullScreenshot(){try{let{width:e,height:t}=await this.getFullSize();return await this.driver.manage().window().setRect({width:e,height:t}),await this.driver.takeScreenshot()}catch(e){throw console.error("ìŠ¤í¬ë¦°ìƒ· ì´¬ì˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:",e),e}}async getFullScreenshot(){try{return await this._getFullScreenshot()}finally{this.close()}}async saveScreenshot(e){try{let t=await this._getFullScreenshot();(0,n.saveFile)(e,t,{encoding:"base64"})}finally{this.close()}}async goto(e){await this.ensureInitialized(),await this.driver.get(e)}async wait(e,i={}){await this.ensureInitialized();let{timeout:n=1e4,until:r="located"}=i;switch(r){case"clickable":return this.driver.wait(t.until.elementIsEnabled(await this.findElement(e)),n);case"visible":return this.driver.wait(t.until.elementIsVisible(await this.findElement(e)),n);case"invisible":return this.driver.wait(t.until.elementIsNotVisible(await this.findElement(e)),n);case"staleness":return this.driver.wait(t.until.stalenessOf(await this.findElement(e)),n);default:return this.driver.wait(t.until.elementLocated(t.By.css(e)),n)}}async _findElements(e,i){switch(e.toLowerCase()){case"id":return await this.driver.findElements(t.By.id(i));case"name":return await this.driver.findElements(t.By.name(i));case"css":return await this.driver.findElements(t.By.css(i));case"xpath":return await this.driver.findElements(t.By.xpath(i));default:throw Error(`ì§€ì›í•˜ì§€ ì•ŠëŠ” ì„ íƒì íƒ€ì…: ${e}`)}}async findElements(e){return await this.ensureInitialized(),await this.driver.findElements(t.By.css(e))}async _findElement(e,i){switch(e.toLowerCase()){case"id":return await this.driver.findElement(t.By.id(i));case"name":return await this.driver.findElement(t.By.name(i));case"css":return await this.driver.findElement(t.By.css(i));case"xpath":return await this.driver.findElement(t.By.xpath(i));default:throw Error(`ì§€ì›í•˜ì§€ ì•ŠëŠ” ì„ íƒì íƒ€ì…: ${e}`)}}async findElement(e){return await this.ensureInitialized(),await this.driver.findElement(t.By.css(e))}async getPageSource(){return await this.ensureInitialized(),await this.driver.getPageSource()}async _getElementHtml(e,t){let i=await this._findElement(e,t);return await i.getAttribute("outerHTML")}async getElementHtml(e){return await (await this.findElement(e)).getAttribute("outerHTML")}async _click(e,t){let i=await this._findElement(e,t);await i.click()}async click(e){let t=await this.findElement(e);await this.scrollIntoView(t),await (0,n.sleepAsync)(1e3),await t.click()}async _getText(e,t){let i=await this._findElement(e,t);return await i.getText()}async getText(e){let t=await this.findElement(e);return await t.getText()}async _getAttribute(e,t,i){let n=await this._findElement(e,t);return await n.getAttribute(i)}async getAttribute(e,t){let i=await this.findElement(e);return await i.getAttribute(t)}async _sendKeys(e,t,i){let n=await this._findElement(e,t);await n.sendKeys(i)}async sendKeys(e,t){let i=await this.findElement(e);await i.sendKeys(t)}async _saveElementScreenshot(e,t,i){let r=await this._findElement(e,t),a=await r.takeScreenshot();(0,n.saveFile)(i,a,{encoding:"base64"})}async saveElementScreenshot(e,t){let i=await this.findElement(e),r=await i.takeScreenshot();(0,n.saveFile)(t,r,{encoding:"base64"})}async executeScript(e,...t){return await this.ensureInitialized(),this.driver.executeScript(e,...t)}async scrollIntoView(e){await this.executeScript("arguments[0].scrollIntoView(true);",e)}async close(){await this.ensureInitialized(),this.driver&&await this.driver.quit(),this.tempUserDataDir&&r.existsSync(this.tempUserDataDir)&&(console.log(`ğŸ’¾ ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€ë¥¼ ìœ„í•´ ì„ì‹œ í”„ë¡œí•„ì„ ë³´ì¡´í•©ë‹ˆë‹¤: ${this.tempUserDataDir}`),console.log("   ë‹¤ìŒ ì‹¤í–‰ ì‹œ ì´ í”„ë¡œí•„ì´ ì¬ì‚¬ìš©ë©ë‹ˆë‹¤."))}constructor(e={headless:!1,profileName:"",email:"",userDataDir:"",arguments:[],useTempProfile:!1}){o(this,"driver",void 0),o(this,"initPromise",void 0),o(this,"tempUserDataDir",void 0),this.initPromise=this.initializeDriver(e)}}
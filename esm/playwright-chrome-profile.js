function e(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}import{chromium as t}from"playwright";import{loadJson as i,saveFile as o,sleepAsync as a}from"jnu-abc";import*as r from"fs";import*as s from"path";import{spawn as n,execSync as l}from"child_process";process.env.CHROMIUM_EXECUTABLE_PATH;let c=e=>{let t=[];try{for(let i of r.readdirSync(e))if(i.startsWith("Profile")){let o=s.join(e,i);try{r.statSync(o).isDirectory()&&t.push(o.replace(/\\/g,"/"))}catch(e){continue}}}catch(t){console.warn(`Error reading directory ${e}: ${t.message}`)}return t},h=(e="",t="")=>{if(t||(t=process.env.CHROMIUM_USERDATA_PATH||"/root/.config/google-chrome"),!e)return"Default";try{let o=c(t),a=[];for(let t of o)try{let o=i(`${t}/Preferences`);if(o.account_info&&o.account_info.length>0){for(let i=0;i<o.account_info.length;i++)if(o.account_info[i].email===e){a.push({folder:t.replace(/\\/g,"/").split("/").pop()||"",isPrimary:0===i});break}}}catch(e){continue}let r=a.find(e=>e.isPrimary);if(r)return console.log(`âœ… ì£¼ê³„ì •ìœ¼ë¡œ ë“±ë¡ëœ í”„ë¡œí•„ ë°œê²¬: ${r.folder}`),r.folder;if(a.length>0)return console.log(`âš ï¸ ë³´ì¡°ê³„ì •ìœ¼ë¡œë§Œ ë“±ë¡ë¨. ì²« ë²ˆì§¸ í”„ë¡œí•„ ì‚¬ìš©: ${a[0].folder}`),a[0].folder}catch(e){console.warn(`Error finding Chrome profiles: ${e.message}`)}return null};class g{async ensureInitialized(){await this.initPromise}async initializeBrowser(e){let i=e.profileName??h(e.email,e.userDataDir)??null;if(!i)throw Error(`Profile not found for email: ${e.email}`);try{l('pkill -f "Google Chrome"',{stdio:"ignore"}),console.log("ğŸ”„ ê¸°ì¡´ Chrome í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ"),await new Promise(e=>setTimeout(e,2e3))}catch(e){}let o=e.userDataDir||process.env.CHROMIUM_USERDATA_PATH||"/Users/youchan/Library/Application Support/Google/Chrome",a=s.join(o,i);if(!r.existsSync(a))throw Error(`Chrome í”„ë¡œí•„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${a}`);console.log(`ğŸ“ Chrome í”„ë¡œí•„: ${a}`);let c=["--remote-debugging-port=9222",`--user-data-dir=${o}`,`--profile-directory=${i}`,"--no-first-run","--disable-default-apps","--start-maximized","--disable-web-security","--allow-running-insecure-content","--disable-features=VizDisplayCompositor",...e.arguments||[]];console.log("ğŸŒ Chrome ì‹¤í–‰ ì¤‘..."),this.chromeProcess=n("/Applications/Google Chrome.app/Contents/MacOS/Google Chrome",c,{detached:!0,stdio:"ignore"}),console.log("â³ Chrome ì‹œì‘ ëŒ€ê¸° ì¤‘... (5ì´ˆ)"),await new Promise(e=>setTimeout(e,5e3)),console.log("ğŸ”— Playwrightë¡œ Chromeì— ì—°ê²° ì¤‘..."),this.browser=await t.connectOverCDP("http://localhost:9222");let g=this.browser.contexts();this.context=g.length>0?g[0]:await this.browser.newContext();let m=await this.context.pages();m.length>0?this.page=m[0]:this.page=await this.context.newPage(),console.log("âœ… Chrome ì—°ê²° ì™„ë£Œ")}async getFullSize(){await this.ensureInitialized();let e=0,t=0;for(;;){let{viewportHeight:i,documentHeight:o,scrollY:a}=await this.page.evaluate(()=>{let e=globalThis,t=e.document;return{viewportHeight:e.innerHeight,documentHeight:Math.max(t.documentElement.scrollHeight,t.body.scrollHeight,t.documentElement.offsetHeight,t.body.offsetHeight),scrollY:e.scrollY||e.pageYOffset}});if(o===e){if(++t>=3)break}else t=0,e=o;let r=Math.min(a+800,o-i);if(a>=o-i)break;await this.page.evaluate(e=>{globalThis.scrollTo(0,e)},r),await this.page.waitForTimeout(2e3);try{await this.page.waitForFunction(e=>{let t=globalThis.document;return Math.max(t.documentElement.scrollHeight,t.body.scrollHeight,t.documentElement.offsetHeight,t.body.offsetHeight)>=e},o,{timeout:3e3})}catch(e){}}return await this.page.evaluate(()=>{let e=globalThis.document;return{width:Math.max(e.documentElement.scrollWidth,e.body.scrollWidth,e.documentElement.offsetWidth,e.body.offsetWidth),height:Math.max(e.documentElement.scrollHeight,e.body.scrollHeight,e.documentElement.offsetHeight,e.body.offsetHeight)}})}async _getFullScreenshot(){try{let{width:e,height:t}=await this.getFullSize();return await this.page.setViewportSize({width:e,height:t}),await this.page.screenshot({fullPage:!0,type:"png"})}catch(e){throw console.error("ìŠ¤í¬ë¦°ìƒ· ì´¬ì˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:",e),e}}async getFullScreenshot(){try{return(await this._getFullScreenshot()).toString("base64")}finally{await this.close()}}async saveScreenshot(e){try{let t=await this._getFullScreenshot();o(e,t.toString("base64"),{encoding:"base64"})}finally{await this.close()}}async goto(e){await this.ensureInitialized(),await this.page.goto(e,{waitUntil:"domcontentloaded"})}async wait(e,t={}){await this.ensureInitialized();let{timeout:i=1e4,state:o="attached"}=t;return this.page.waitForSelector(e,{timeout:i,state:o})}async findElements(e){return await this.ensureInitialized(),this.page.locator(e)}async findElement(e){return await this.ensureInitialized(),this.page.locator(e).first()}async getPageSource(){return await this.ensureInitialized(),await this.page.content()}async getElementHtml(e){let t=await this.findElement(e);return await t.innerHTML()}async click(e){let t=await this.findElement(e);await t.scrollIntoViewIfNeeded(),await a(1e3),await t.click()}async getText(e){let t=await this.findElement(e);return await t.textContent()}async getAttribute(e,t){let i=await this.findElement(e);return await i.getAttribute(t)}async sendKeys(e,t){let i=await this.findElement(e);await i.fill(t)}async saveElementScreenshot(e,t){let i=await this.findElement(e);o(t,(await i.screenshot({type:"png"})).toString("base64"),{encoding:"base64"})}async executeScript(e,...t){return await this.ensureInitialized(),this.page.evaluate(e,...t)}async scrollIntoView(e){let t=await this.findElement(e);await t.scrollIntoViewIfNeeded()}async close(){if(await this.ensureInitialized(),this.browser&&(await this.browser.close(),console.log("âœ… Playwright ì—°ê²° ì¢…ë£Œ")),this.chromeProcess)try{process.kill(-this.chromeProcess.pid),console.log("âœ… Chrome í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ")}catch(e){console.log("â„¹ï¸ Chrome í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì‹¤íŒ¨ (ì´ë¯¸ ì¢…ë£Œë˜ì—ˆì„ ìˆ˜ ìˆìŒ)")}}constructor(t={headless:!1,profileName:"",email:"",userDataDir:"",arguments:[]}){e(this,"browser",void 0),e(this,"context",void 0),e(this,"page",void 0),e(this,"initPromise",void 0),e(this,"chromeProcess",void 0),this.initPromise=this.initializeBrowser(t)}}export{g as PlaywrightChromeProfile,h as getPlaywrightChromeProfileByEmail};